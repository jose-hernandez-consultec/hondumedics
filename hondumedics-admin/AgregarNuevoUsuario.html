<!DOCTYPE html>
<html>

<head>
    <title>Agregar Nuevo Usuario / Administrador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- JQuery JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Charts-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="../hondumedics/src/funciones.js"></script>

    <!--Estilos CSS-->
    <style>
        .nav-wrapper {
            background-color: #464646;
        }

        .waves-effect.waves-pink .waves-ripple {
            background-color: #464646;
        }

        .btn-pink {
            background-color: #464646;
        }

        .btn-bordes {
            border: white 2px solid;
        }

        .page-footer {
            background: #464646;
        }

        #topbarsearch .input-field .prefix {
            width: 0rem !important;
        }

        #topbarsearch nav ul li:hover,
        nav ul li.active {
            background-color: none !important;
        }

        .input-field .prefix~input,
        .input-field .prefix~textarea,
        .input-field .prefix~label,
        .input-field .prefix~.validate~label,
        .input-field .prefix~.autocomplete-content {
            margin-left: 1rem !important;
        }

        .dropdown-content {
            background-color: #FFFFFF;
            margin: 0;
            display: none;
            min-width: 300px;
            /* Changed this to accomodate content width */
            max-height: auto;
            margin-left: -1px;
            /* Add this to keep dropdown in line with edge of navbar */
            overflow: hidden;
            /* Changed this from overflow-y:auto; to overflow:hidden; */
            opacity: 0;
            position: absolute;
            white-space: nowrap;
            z-index: 1;
            will-change: width, height;
        }

        #back1 {
            z-index: 10;
            position: relative;
        }

        #back2 {
            z-index: 10;
            position: relative;
        }

        #back3 {
            z-index: 0;
            position: relative;
        }

        #back4 {
            z-index: 0;
            position: relative;
        }

        .content {
            padding-left: 300px;
            height: 100%;
        }

        .card-bg {
            background: white;
        }

        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            -ms-overflow-style: -ms-autohiding-scrollbar;
        }

        table.striped>tbody>tr:nth-child(odd) {
            background-color: white;
        }

        .imgRedonda {
            width: 60px;
            height: 60px;
            border-radius: 150px;
        }

        .container-1 {
            width: 100%;
            max-width: initial;
        }

        .container-1>.row {
            margin: 0;
        }

        .container-1>.row>.col {
            padding: 0;
        }

        table {
            width: 100%;
            height: 50½;
            text-align: center;
        }

        th {
            text-align: center;
        }

        td {
            width: 0px;
            height: 30px;
            text-align: center;
        }

        .content {
            padding-left: 300px;
            height: 100%;
        }

        h1 {
            color: #448aff;
        }

        .sidenav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 22%;
            will-change: opacity;
        }
    </style>

</head>

<body>
    <!--Formulario de Agregar Nuevo Usuario-->
    <!--Navbar-->
    <div class="row">
        <nav class="nav-wrapper">
            <div class="nav-wrapper">
                <a href="" class=" left sidenav-trigger hide-on-medium-and-up" data-target="sidenav-1">
                    <i class="material-icons">menu</i></a>
                <div class="col s3"></div>
                <div class="col s9">
                    <a class="brand-logo link-dashboard">HM Admin Panel</a>
                    <ul class="right hide-on-med-and-down">

                        <!-- Dropdown Trigger Menú Administrador-->
                        <li>
                            <a href="#" class="dropdown-trigger" data-target="dropdown1">
                                Hola, <span style="font-size: 15px; font-weight: bold;" id="username"></span>
                                <i class="material-icons right">arrow_drop_down</i>
                            </a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
    <!-- Dropdown Structure Lista de menú de Administrador-->
    <ul id='dropdown1' class='dropdown-content'>
        <li><a onclick="logoutAdmin();">
                <span style="color: #464646;">
                    <center>Cerrar Sesión</center>
                </span>
            </a></li>
    </ul>

    <!-- Menú oculto-->
    <ul class="sidenav sidenav-fixed" id="sidenav-1">
        <li>
            <div class="user-view">
                <div class="background">
                    <img src="https://hdblackwallpaper.com/wallpaper/2015/04/1200-x-900-solid-black-wallpaper-22-wide-wallpaper.jpg"
                        style="height: 100%; width: 100%;" alt="" class="responsive-img">
                </div>
                <span class="white-text name"><span style="font-size: 15px; font-weight: bold;"
                        id="username1"></span></span>
                <span class="white-text email"><span id="email1"></span>
            </div>
        </li>
        <li>
            <a class="link-dashboard"><i class="material-icons black-text">dashboard</i>Dashboard
            </a>
        </li>
        <li>
            <a class="link-pacientes"><i class="material-icons black-text">person</i>Pacientes
            </a>
        </li>

        <li>
            <a class="link-doctores"><i class="material-icons black-text">people</i>Doctores
            </a>
        </li>
        <li>
            <a class="link-solicitudes"><i class="material-icons black-text">assignment_turned_in</i>Solicitudes
            </a>
        </li>
        <li>
            <a class="link-solicitudes-rechazadas"><i class="material-icons black-text">cancel</i>Solicitudes Rechazadas
            </a>
        </li>
        <li>
            <a class="link-citas"><i class="material-icons black-text">date_range</i>Citas
            </a>
        </li>
        <li>
            <a class="link-hospitales"><i class="material-icons black-text">local_hospital</i>Hospitales
            </a>
        </li>
        <li>
            <a class="link-especialidades"><i class="material-icons black-text">colorize</i>Especialidades
            </a>
        </li>
        <div class="divider"></div>
        <li>
            <a class="link-agregar-nuevo-usuario"><i class="material-icons black-text">add</i>Agregar Nuevo Usuario
            </a>
        </li>
        <li>
            <a onclick="logoutAdmin();"><i class="material-icons black-text">exit_to_app</i>Cerrar Sesión
            </a>
        </li>
    </ul>
    <!--SideNav Finished-->

    <!-- Panel de Agregar Nuevo Usuario-->
    <div class="" style="min-height: 657px;">
        <form id="form1">
            <div class="container-1">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="row">
                        <div class="col s3"></div>
                        <div class="col s9">
                            <h2 class="black-text center">Agregar Nuevo Usuario</h2>
                        </div>
                        <div class="container">
                            <div class="row">
                                <div class="col s4"></div>
                                <form class="col s8" method="POST" id="formulario" onsubmit="this.reset()"><br>
                                    <div class="row">
                                        <div class="input-field col s4">
                                            <input id="first_name" name="first_name" type="text" class="validate">
                                            <label for="first_name">Nombre</label>
                                        </div>
                                        <div class="input-field col s4">
                                            <input id="last_name" name="last_name" type="text" class="validate">
                                            <label for="last_name">Apellido</label>
                                        </div>
                                    </div>
                                    <div class="col s4"></div>
                                    <div class="row">
                                        <div class="input-field col s4">
                                            <input id="email" name="email" type="email" class="validate">
                                            <label for="email">Correo</label>
                                        </div>
                                        <div class="input-field col s4">
                                            <input id="password" name="password" type="password" class="validate">
                                            <label for="password">Contraseña</label>
                                        </div>
                                    </div>
                                    <div class="col s4"></div>
                                    <div class="row">
                                        <div class="input-field col s4">
                                            <input id="username_text" name="username_text" type="text" class="validate">
                                            <label for="username_text">Nombre de Usuario</label>
                                        </div>
                                        <div class="input-field col s4">
                                            <label>Tipo de Acceso</label>
                                            <br>
                                            <br>
                                            <select class="browser-default" id="access">
                                                <option value="" disabled selected>Seleccione Su Opción</option>
                                                <option id="opcion0" value="0">Usuario Común</option>
                                                <option id="opcion1" value="1">Administrador</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <br>
                                        <div class="col s3"></div>
                                        <div class="input-field col s5 m5">
                                            <a id="btnAgregar" class="waves-effect waves-light btn blue right"><i
                                                    class="material-icons left">save</i>Agregar
                                                Usuario</a>
                                        </div>
                                        <div class="input-field col s4 m4">
                                            <a id="btnCancelar" class="waves-effect waves-light btn red"><i
                                                    class="material-icons left">cancel</i>Cancelar</a>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        //Este método se utiliza para hacer que una función esté disponible después de cargar el documento.
        $(document).ready(function () {


            if (localStorage.getItem('admin') !== undefined && localStorage.getItem('admin') !== null){
                //Get Patient ID From Local Storage
                var admin_id = JSON.parse(localStorage.getItem("admin")).admin_id;
                $.ajax({
                    url: 'http://localhost:5000/admins/getAdminByid',
                    dataType: 'json',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ "admin_id": admin_id }),
                    processData: false,
                    success: function (admin_data) {
                        if (admin_data.found) {
                            console.log(admin_data);
                            //Inicialización de las propiedades de Materialize css.
                            M.AutoInit();
                            $('.sidenav').sidenav();
                            $('.sidenav-trigger').sidenav();
                            $('.sidenav-1').sidenav({ edge: 'left' });
                            $('select').formSelect();
                            $('.dropdown-trigger').dropdown({
                                coverTrigger: false,
                                belowOrigin: true
                            });

                            $("#UserName").text(admin_data.admin.first_name + " " + admin_data.admin.last_name);
                            $("#UserName1").text(admin_data.admin.first_name + " " + admin_data.admin.last_name);
                            $("#username").text(admin_data.admin.first_name + " " + admin_data.admin.last_name);
                            $("#email1").text(admin_data.admin.email);
                        }

                    }
                });

                //Cancelar o limpiar el formulario.
                $("#btnCancelar").click(function () {
                    $("#formulario")[0].reset();
                });

                var form = $("#formulario");

                //El método click() adjunta una función de controlador de eventos a un elemento HTML.
                //La función se ejecuta cuando el usuario hace clic en el elemento HTML.
                $("#btnAgregar").click(function (e) {
                    e.preventDefault(); //Detiene la acción predeterminada de un elemento.
                    //Obtener campos de entradas del formulario, Obtener el valor de un elemento .val()
                    var nombre_usuario = $('#first_name').val();
                    var apellido_usuario = $('#last_name').val();
                    var email_usuario = $('#email').val();
                    var pass_usuario = $('#password').val();
                    var username_usuario = $('#username_text').val();
                    var seleccionar_usuario = $('#access').val();

                    var error_messages = [];

                    //Validar que nada este vacio
                    var valido = true;
                    if (nombre_usuario === "" || nombre_usuario.length === 0) {
                        error_messages.push("<span> - El nombre no puede estar vacío. </span><br>");
                        valido = false;
                    }

                    if (apellido_usuario == "" || apellido_usuario.length === 0) {
                        error_messages.push("<span> - El apellido no puede estar vacío. </span><br>");
                        valido = false;
                    }
                    if (email_usuario == "" || email_usuario.length === 0) {
                        error_messages.push("<span> - El correo electrónico no puede estar vacío. </span><br>");
                        valido = false;
                    }else{
                        if (!isValidEmail(email_usuario)) {
                            error_messages.push("<span> - El correo electrónico es inválido. </span><br>");
                            valid = false;
                        }
                    }

                    

                    //Función es correo electrónico válido
                    function isValidEmail(email_usuario) {
                        //Verificar la longitud mínima válida de un correo electrónico
                        if (email_usuario.length <= 2) {
                            return false;
                        }

                        //Si el correo electrónico tiene carácter @
                        if (email_usuario.indexOf("@") == -1) {
                            return false;
                        }

                        var partes = email_usuario.split("@");
                        var punto = partes[1].indexOf(".");
                        var longitud = partes[1].length;
                        var divisiones_puntos = partes[1].split(".");
                        var recuento_puntos = divisiones_puntos.length - 1;

                        //Verificar si el punto está presente y ese mínimo un carácter después de @
                        if (punto == -1 | punto < 2 || recuento_puntos > 2) {
                            return false;
                        }

                        //Comprobar si el punto no es el último carácter y si los puntos no se repiten
                        for (var i = 0; i < divisiones_puntos.length; i++) {
                            if (divisiones_puntos[i].length == 0) {
                                return false;
                            }
                        }
                        return true;
                    }

                    if (pass_usuario == "" || pass_usuario.length === 0) {
                        error_messages.push("<span> - La contraseña no puede estar vacía. </span><br>");
                        valido = false;
                    }

                    if (username_usuario == "" || username_usuario.length === 0) {
                        error_messages.push("<span> - El nombre de usuario no puede estar vacío. </span><br>");
                        valido = false;
                    }

                    if (parseInt(seleccionar_usuario) != 0 && parseInt(seleccionar_usuario) != 1) {
                        error_messages.push("<span> - Debe seleccionar una opcíon de tipo de usuario. </span><br>");
                        valido = false;
                    }

                    //Método Ajax, permite al navegador enviar y recibir datos en  el fondo (background).
                    if (valido) {
                        $.ajax({
                            url: 'http://localhost:5000/admins/addNewAdmin',
                            dataType: 'json',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ "first_name": nombre_usuario, "last_name": apellido_usuario, "email": email_usuario, "password": pass_usuario, "username": username_usuario, "access": seleccionar_usuario }),
                            processData: false,
                            success: function (data) {
                                console.log(data);
                                if (data.auth) {
                                    Swal.fire({
                                        title: "Nuevo Usuario Agregado!",
                                        icon: 'success',
                                        confirmButtonText: 'Entendido'
                                    });
                                }
                            },
                            error: function (error) {
                                console.log(error);
                                if (error.status === 403) {
                                    Swal.fire({
                                        title: "Ya existe un usuario con ese correo electronico!",
                                        icon: 'warning',
                                        confirmButtonText: 'Entendido'
                                    });
                                }
                            }
                        });
                    } else {
                        var errors = "<p>" + error_messages.join('') + "</p>";
                        Swal.fire({
                            title: 'Hay errores en el formulario!',
                            html: errors,
                            icon: 'error',
                            confirmButtonText: 'Entendido'
                        });
                    }
                });

                //Evento Click del link con clase llamada link-dashboard
                $(".link-dashboard").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./dashboard.html"
                });

                //Evento Click del link con clase llamada link-pacientes
                $(".link-pacientes").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./ListaPacientes.html"
                });

                //Evento Click del link con clase llamada link-doctores
                $(".link-doctores").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./ListaDoctores.html"
                });

                //Evento Click del link con clase llamada link-solicitudes
                $(".link-solicitudes").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./SolicitudesDeDoctores.html"
                });

                //Evento Click del link con clase llamada link-solicitudes-rechazadas
                $(".link-solicitudes-rechazadas").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./SolicitudesRechazadas.html"
                });

                //Evento Click del link con clase llamada link-citas
                $(".link-citas").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./ListaCitas.html"
                });

                //Evento Click del link con clase llamada link-citas
                $(".link-hospitales").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./Hospitales.html"
                });

                //Evento Click del link con clase llamada link-citas
                $(".link-especialidades").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./Especialidades.html"
                });

                //Evento Click del link con clase llamada link-agregar-nuevo-usuario
                $(".link-agregar-nuevo-usuario").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./AgregarNuevoUsuario.html"
                });

                //Evento Click del link con clase llamada link-perfil-doctor
                $(".link-perfil-doctor").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./UserProfileDoctor.html"
                });

                //Evento Click del link con clase llamada link-perfil-paciente
                $(".link-perfil-paciente").click(function () {
                    //las variables first_name, last_name y email estan declaradas en las lineas 890, 891 y 892 respectivamente
                    window.location.href = "./UserProfilePatient.html"
                });
            }else{
                window.location.href = "./AdminLogin.html"
            }
        });
    </script>
</body>

</html>