<!DOCTYPE html>
<html>

<head>
    <title>Perfil | Paciente</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- JQuery JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!-- Compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- Compiled and minified JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
    <script src="./src/funciones.js"></script>

    <!-- Estilos CSS -->
    <style>
        .nav-wrapper {
            background-color: #FC5A5A;
        }

        .waves-effect.waves-pink .waves-ripple {
            background-color: #FC5A5A;
        }

        .btn-pink {
            background-color: #FC5A5A;
        }

        .btn-bordes {
            border: white 2px solid;
        }

        .card-image {
            position: relative;
            width: 200px;
            height: 200px;
            overflow: hidden;
            border-radius: 50%;
            display: block;
            margin: auto;
        }

        /*.circular--portrait {
            position: relative;
            width: 200px;
            height: 200px;
            overflow: hidden;
            border-radius: 50%;
        }*/

        .circular--portrait img {
            width: 100%;
            height: auto;
            margin-left: -50px;
        }

        .circular--landscape img {
            width: auto;
            height: 100%;
            margin-left: 0%;
        }
    </style>
</head>

<body>
    <!-- Formulario de Dashboard -->
    <div class="row">
        <nav class="nav-wrapper">
            <div class="nav-wrapper">
                <div class="col s1"></div>
                <div class="col s10">
                    <a href="index.html" class="brand-logo">HoduMedics</a>
                    <ul class="right hide-on-med-and-down">
                        <!-- Notifications -->
                        <li><a class='dropdown-trigger' href='#' data-target='dropdown2'>
                                <span style="color: #FC5A5A;">Notificaciones</span>
                                <span class="new badge red">3</span><i class="material-icons right">notifications_none
                                    <small class="notification-badge">3</small>
                                </i></a>
                        </li>

                        <!-- Dropdown Trigger Menú Administrador-->
                        <li>
                            <a href="#" class="dropdown-trigger" data-target="dropdown1">
                                Hola, <span style="font-size: 14px; font-weight: bold;" id="username"></span>
                                <i class="material-icons right">arrow_drop_down</i>
                            </a></li>
                    </ul>
                </div>
                <div class="col s1"></div>
            </div>
        </nav>
    </div>
    <!-- Dropdown Structure Menú Administrador-->
    <ul id='dropdown1' class='dropdown-content'>
        <li><a href="Perfil.html">
                <span style="color: #464646;">
                    <center>Mi perfil</center>
                </span>
            </a></li>
        <li class="divider"></li>
        <li><a href="Configuracion.html">
                <span style="color: #464646;">
                    <center>Configuración</center>
                </span>
            </a></li>
        <li class="divider"></li>
        <li><a class="logout" onClick="logout();">
                <span style="color: #464646;">
                    <center>Cerrar Sesión</center>
                </span>
            </a></li>
    </ul>

    <!-- Lista de Menú de Notificaciones -->
    <ul id="dropdown2" class="dropdown-content collection with-header">
        <li class="collection-header"><a href="" style="color: red;">Borrar Todo</a></li>

        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <center>
                <font face="times new roman" size=1>
                    <p class="noti-details"><span class="noti-title">Dr. Ruby Perrin</span> Schedule <span
                            class="noti-title">her appointment</span></p><span class="new badge red">1</span>
                </font>
                <font face="times new roman">
                    <p class="noti-time"><span class="notification-time">Hace 4 minutos</span></p>
                </font>
            </center>
        </li>
        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <center>
                <font face="times new roman" size=1>
                    <p class="noti-details"><span class="noti-title">Charlene Reed</span> has booked her appointment to
                        <span class="noti-title">Dr. Ruby Perrin</span></p><span class="new badge red">1</span>
                </font>
                <font face="times new roman">
                    <p class="noti-time"><span class="notification-time">Hace 10 minutos</span></p>
                </font>
            </center>
        </li>
        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <center>
                <font face="times new roman" size=1>
                    <p class="noti-details"><span class="noti-title">Travis Trimble</span> sent a amount of $210 for his
                        <span class="noti-title">appointment</span></p><span class="new badge red">1</span>
                </font>
                <font face="times new roman">
                    <p class="noti-time"><span class="notification-time">Hace 30 minutos</span></p>
                </font>
            </center>
        </li>
    </ul>

    <!-- Dropdown Structure Imágenes de forma redonda en las notificaciones -->
    <ul id="dropdown" class="dropdown-content collection" style="position: absolute; left: 100%;">
        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <span class="title">Name</span>
            <p>First Line</p>
            <a href="#!" class="secondary-content"><i class="material-icons">contact_mail</i></a>
        </li>
        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <span class="title">Name</span>
            <p>First Line</p>
            <a href="#!" class="secondary-content"><i class="material-icons">contact_mail</i></a>
        </li>
        <li class="collection-item avatar">
            <img src="http://materializecss.com/images/yuna.jpg" alt="" class="circle">
            <span class="title">Name</span>
            <p>First Line</p>
            <a href="#!" class="secondary-content"><i class="material-icons">contact_mail</i></a>
        </li>
    </ul>
    <!--SideNav Finished-->

    <!--Página de Perfil-->
    <br>
    <div class="row">
        <div class="col s12 m6 l3">
            <div class="card">
                <div class="card-image circular--landscape">
                    <img class="profile_picture"
                        src="">
                </div>
                <br>
                <center>
                    <!-- Modal Trigger -->
                    <a class="waves-effect waves-light btn blue modal-trigger" href="#modal1"><i
                            class="material-icons left white-text">add_a_photo</i>CAMBIAR
                        FOTO</a>
                    <!-- Modal Structure -->
                    <div id="modal1" class="modal modal-fixed-footer">
                        <div class="modal-content">
                            <h4 style="text-align: center;">Cambiar Foto de Perfil
                            </h4>
                            <br>
                            <div class="row">
                                <form class="col s12">
                                    <br>
                                    <br>
                                    <br>
                                    <div class="row">
                                        <label>Imagen</label>
                                        <div class="file-field input-field">
                                            <div class="btn green">
                                                <i class="material-icons left white-text">cloud_upload</i>
                                                <span>Seleccionar Archivo</span>
                                                <input type="file" class="picture-upload" />
                                            </div>
                                            <div class="file-path-wrapper">
                                                <input class="file-path validate" type="text"
                                                    placeholder="Subir Archivo" />
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <a class="modal-close waves-effect waves-green btn-flat red white-text">Salir</a>
                        </div>
                    </div>

                </center>
                <div class="card-content">
                    <span class="card-title center-align truncate"><span style="font-size: 18px; font-weight: bold;"
                            id="Name"></span></span>
                    <center>
                        <h6><i class="material-icons">cake</i><span id="fechaNacimiento"></span></h6>
                    </center>
                    <center>
                        <h6><i class="material-icons">location_on</i>Tegucigalpa, Honduras</h6>
                    </center>
                </div>
                </center>
            </div>
        </div>
        <div class="col s12 m6 l9">
            <div class="card">
                <div class="card-content">
                    <left>
                        <h5><b>Perfil</b></h5>
                    </left>
                    <br>
                    <div class="row">
                        <form class="col s12">
                            <div class="row">
                                <div class="input-field col s6">
                                    <i class="material-icons prefix">account_circle</i>
                                    <input id="first_name" type="text" class="validate">
                                    <label class="active" for="first_name">NOMBRE</label>
                                </div>
                                <div class="input-field col s6">
                                    <i class="material-icons prefix">account_circle</i>
                                    <input id="last_name" type="text" class="validate">
                                    <label class="active" for="last_name">APELLIDO</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <i class="material-icons prefix">date_range</i>
                                    <input id="date_of_birth" type="text" class="datepicker">
                                    <label class="active" for="date_of_birth">FECHA DE NACIMIENTO</label>
                                </div>
                                <div class="input-field col s6">
                                    <i class="material-icons prefix">phone</i>
                                    <input id="phone_number" type="text" class="validate">
                                    <label class="active" for="phone_number">TELÉFONO</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">email</i>
                                    <input disabled id="email" value="Correo Electronico" type="text" class="validate">
                                    <label for="email">CORREO ELECTRÓNICO</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">home</i>
                                    <textarea id="address_house" class="materialize-textarea"></textarea>
                                    <label class="active" for="address_house">DIRECCIÓN DE CASA</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <i class="material-icons prefix">work</i>
                                    <textarea id="address_work" class="materialize-textarea"></textarea>
                                    <label class="active" for="address_work">DIRECCIÓN DE TRABAJO</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <label>Género</label>
                                    <br>
                                    <br>
                                    <select class="browser-default" id="gender">
                                        <option value="" disabled selected>Favor Seleccionar Género</option>
                                        <option id="opcion0" value="0">Femenino</option>
                                        <option id="opcion1" value="1">Masculino</option>
                                    </select>
                                </div>
                                <div class="input-field col s6">
                                    <label>Tipo de sangre</label>
                                    <br>
                                    <br>
                                    <select class="browser-default" id="blood_type">
                                        <option value="" disabled selected>Favor Seleccionar Tipo De Sangre</option>
                                        <option id="opcion0" value="0">A-</option>
                                        <option id="opcion1" value="1">A+</option>
                                        <option id="opcion2" value="2">B-</option>
                                        <option id="opcion3" value="3">B+</option>
                                        <option id="opcion4" value="4">O-</option>
                                        <option id="opcion5" value="5">O+</option>
                                        <option id="opcion6" value="6">AB-</option>
                                        <option id="opcion7" value="7">AB+</option>
                                    </select>
                                </div>
                            </div>
                            <center>
                                <div class="col s12 m4 l4"></div>
                                <div class="col s12 m4 l4">
                                    <a id="btnGuardarCambiosPaciente" href="#!"
                                        class="btn waves-effect waves-green btn-flat blue white-text"><i
                                            class="material-icons left">save</i>Guardar
                                        Cambios</a>
                                </div>
                                <div class="col s12 m4 l4"></div>
                            </center>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        //Este método se utiliza para hacer que una función esté disponible después de cargar el documento.
        $(document).ready(function (e) {
            //Inicialización de las propiedades de Materialize css.

            if (localStorage.getItem('patient') !== undefined && localStorage.getItem('patient') !== null){
                //Get Patient ID From Local Storage
                var patient_id = JSON.parse(localStorage.getItem("patient")).patient_id;
                var profile_picture = "";
                $.ajax({
                    url: 'http://localhost:5000/patientProfiles/getPatientProfileByPatientID',
                    dataType: 'json',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ "patient_id": patient_id}),
                    processData: false,
                    success: function (profile_data) {
                        console.log(profile_data);
                        $.ajax({
                            url: 'http://localhost:5000/patients/getPatientById',
                            dataType: 'json',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({ "patient_id": patient_id}),
                            processData: false,
                            success: function (user_data) {
                                console.log(user_data);
                                $("#username").text(user_data.patient.first_name + " " + user_data.patient.last_name);
                                $("#Name").text(user_data.patient.first_name + " " + user_data.patient.last_name);
                                $("#fechaNacimiento").text(user_data.patient.birthdate);
                                $("#first_name").val(user_data.patient.first_name);
                                $("#last_name").val(user_data.patient.last_name);
                                $("#email").val(user_data.patient.email);
                                $("#date_of_birth").val(user_data.patient.birthdate);
                                $("#gender").val(user_data.patient.gender).change();
                                
                                $('#address_house').val(profile_data.patient_profile.home_address),
                                $('#address_work').val(profile_data.patient_profile.work_address),
                                $('#blood_type option:selected').text(profile_data.patient_profile.blood_type),
                                $('#phone_number').val(profile_data.patient_profile.phone_number)

                                //Focus all Editable Fields

                                $("#first_name").focus();
                                $("#last_name").focus();
                                $("#phone_number").focus();
                                $("#address_house").focus();
                                $("#address_work").focus();
                                $("#date_of_birth").focus();
                                $("#email").focus();
                                
                                if (profile_data.patient_profile.profile_picture !== null){
                                    $(".profile_picture").attr('src', profile_data.patient_profile.profile_picture)
                                }else{
                                    $(".profile_picture").attr('src', "data:image/png;base64,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");
                                }
                            }
                        });                   
                    }
                });

                M.AutoInit();
                $('.sidenav').sidenav();
                $('.dropdown-trigger').dropdown({
                    coverTrigger: false,
                    belowOrigin: true
                });
                $('.modal').modal();
                $('.datepicker').datepicker();


                $(".picture-upload").on('change', function (){
                     var fileReader = new FileReader();
                     fileReader.onload = function() {
                         var data = fileReader.result;
                         $.ajax({
                            url: 'http://localhost:5000/patientProfiles/updatePatientProfilePictureByPatientId',
                            dataType: 'json',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                "patient_id": patient_id,
                                "profile_picture": data,
                            }),
                            processData: false,
                            success: function (result) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Excelente!',
                                    text: 'Su foto de perfil ha sido actualizada!',
                                    confirmButtonText: 'Entendido'
                                }).then((result2) => {
                                    if (result2.value) {
                                        $(".profile_picture").attr('src', result.image);
                                    }
                                });
                            },
                            error: function (error){

                            }
                        });
                     };
                     fileReader.readAsDataURL($('.picture-upload').prop('files')[0]);
                });

                //El método click() adjunta una función de controlador de eventos a un elemento HTML.
                //La función se ejecuta cuando el usuario hace clic en el elemento HTML.
                $('#btnGuardarCambiosPaciente').click(function (e) {
                    e.preventDefault();
                    var error_messages = [];
                    var valido = true;
                    if ($('#first_name').val() == "" || $('#first_name').val().length === 0) {
                        error_messages.push("<span> - El campo de nombre no puede estar vació. </span><br>");
                        valido = false;
                    }

                    if ($('#last_name').val() == "" || $('#last_name').val().length === 0) {
                        error_messages.push("<span> - El campo de apellido no puede estar vació. </span><br>");
                        valido = false;
                    }

                    if (valido){
                        $.ajax({
                            url: 'http://localhost:5000/patientProfiles/updatePatientProfileByPatiendID',
                            dataType: 'json',
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                "patient_id": patient_id,
                                "first_name": $('#first_name').val(),
                                "last_name": $('#last_name').val(),
                                "home_address": $('#address_house').val(),
                                "birthdate": $('#date_of_birth').val(),
                                "work_address": $('#address_work').val(),
                                "blood_type": $('#blood_type option:selected').text(),
                                "phone_number": $('#phone_number').val()
                            }),
                            processData: false,
                            success: function (result) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Excelente!',
                                    text: 'Los datos de su perfil han sido actualizados!',
                                    confirmButtonText: 'Entendido'
                                })
                            }
                        });
                    }else{
                        var errors = "<p>" + error_messages.join('') + "</p>";
                        Swal.fire({
                            title: 'Hay errores en el formulario!',
                            html: errors,
                            icon: 'error',
                            confirmButtonText: 'Entendido'
                        });
                    }
                });
            }else{
                window.location.href = "./Login.html";
            }
        }); 
    </script>
</body>

</html>